@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="face-capture-container">
    @if (!IsCameraActive && CapturedImage == null)
    {
        <div class="camera-preview-placeholder">
            <button class="btn btn-primary btn-lg" @onclick="StartCameraAsync">
                <i class="bi bi-camera"></i> Start Camera
            </button>
            <p class="mt-3 text-muted">Click to activate your camera for face capture</p>
        </div>
    }
    else if (IsCameraActive && CapturedImage == null)
    {
        <div class="camera-active">
            <div class="video-container">
                <video id="@VideoElementId" autoplay playsinline class="camera-video"></video>
                <div class="face-guide-overlay">
                    <div class="face-guide-circle"></div>
                </div>
            </div>
            
            <div class="camera-controls mt-3">
                @if (!string.IsNullOrEmpty(LightingFeedback))
                {
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> @LightingFeedback
                    </div>
                }
                
                <div class="instructions mb-3">
                    <p><strong>Position your face in the circle</strong></p>
                    <ul class="text-start">
                        <li>Look directly at the camera</li>
                        <li>Ensure good lighting</li>
                        <li>Remove glasses if possible</li>
                        <li>Keep a neutral expression</li>
                    </ul>
                </div>
                
                <button class="btn btn-success btn-lg me-2" @onclick="CapturePhotoAsync" disabled="@IsCapturing">
                    @if (IsCapturing)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    <i class="bi bi-camera-fill"></i> Capture Photo
                </button>
                <button class="btn btn-secondary" @onclick="StopCameraAsync">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
            </div>
        </div>
    }
    else if (CapturedImage != null)
    {
        <div class="captured-preview">
            <h5>Captured Photo</h5>
            <img src="@CapturedImage" alt="Captured face" class="preview-image" />
            
            <div class="preview-controls mt-3">
                <button class="btn btn-primary me-2" @onclick="ConfirmPhotoAsync">
                    <i class="bi bi-check-circle"></i> Use This Photo
                </button>
                <button class="btn btn-secondary" @onclick="RetakePhotoAsync">
                    <i class="bi bi-arrow-clockwise"></i> Retake
                </button>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger mt-3">
            <i class="bi bi-exclamation-circle"></i> @ErrorMessage
        </div>
    }
</div>

@code {
    [Parameter]
    public EventCallback<string> OnPhotoCapture { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    private string VideoElementId = $"video-{Guid.NewGuid()}";
    private bool IsCameraActive = false;
    private bool IsCapturing = false;
    private string? CapturedImage = null;
    private string? ErrorMessage = null;
    private string? LightingFeedback = null;
    private IJSObjectReference? _cameraModule;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _cameraModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/camera.js");
        }
    }

    private async Task StartCameraAsync()
    {
        try
        {
            ErrorMessage = null;
            if (_cameraModule != null)
            {
                var success = await _cameraModule.InvokeAsync<bool>("camera.initializeCamera", VideoElementId);
                if (success)
                {
                    IsCameraActive = true;
                    StateHasChanged();
                    
                    // Start checking lighting periodically
                    _ = MonitorLightingAsync();
                }
                else
                {
                    ErrorMessage = "Failed to initialize camera. Please check permissions.";
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error starting camera: {ex.Message}";
        }
    }

    private async Task MonitorLightingAsync()
    {
        while (IsCameraActive && CapturedImage == null && _cameraModule != null)
        {
            try
            {
                await Task.Delay(2000);
                if (IsCameraActive && _cameraModule != null)
                {
                    var lighting = await _cameraModule.InvokeAsync<string>("camera.detectLighting", VideoElementId);
                    LightingFeedback = lighting switch
                    {
                        "too-dark" => "⚠️ Lighting is too dark - please move to a brighter area",
                        "too-bright" => "⚠️ Lighting is too bright - please reduce direct light",
                        _ => null
                    };
                    StateHasChanged();
                }
            }
            catch
            {
                // Ignore errors during monitoring
                break;
            }
        }
    }

    private async Task CapturePhotoAsync()
    {
        try
        {
            IsCapturing = true;
            ErrorMessage = null;
            StateHasChanged();

            if (_cameraModule != null)
            {
                var photoData = await _cameraModule.InvokeAsync<string>("camera.capturePhoto", VideoElementId);
                if (!string.IsNullOrEmpty(photoData))
                {
                    CapturedImage = photoData;
                }
                else
                {
                    ErrorMessage = "Failed to capture photo. Please try again.";
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error capturing photo: {ex.Message}";
        }
        finally
        {
            IsCapturing = false;
        }
    }

    private async Task StopCameraAsync()
    {
        try
        {
            if (_cameraModule != null)
            {
                await _cameraModule.InvokeVoidAsync("camera.stopCamera", VideoElementId);
            }
            IsCameraActive = false;
            CapturedImage = null;
            ErrorMessage = null;
            LightingFeedback = null;
            
            await OnCancel.InvokeAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error stopping camera: {ex.Message}";
        }
    }

    private async Task RetakePhotoAsync()
    {
        CapturedImage = null;
        ErrorMessage = null;
        await StartCameraAsync();
    }

    private async Task ConfirmPhotoAsync()
    {
        if (!string.IsNullOrEmpty(CapturedImage))
        {
            await OnPhotoCapture.InvokeAsync(CapturedImage);
            await StopCameraAsync();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_cameraModule != null)
        {
            try
            {
                await _cameraModule.InvokeVoidAsync("camera.stopCamera", VideoElementId);
                await _cameraModule.DisposeAsync();
            }
            catch
            {
                // Ignore disposal errors
            }
        }
    }
}

<style>
    .face-capture-container {
        max-width: 600px;
        margin: 0 auto;
        text-align: center;
    }

    .camera-preview-placeholder {
        padding: 3rem;
        border: 2px dashed #ccc;
        border-radius: 8px;
        background: #f8f9fa;
    }

    .video-container {
        position: relative;
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .camera-video {
        width: 100%;
        display: block;
        background: #000;
    }

    .face-guide-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .face-guide-circle {
        width: 250px;
        height: 320px;
        border: 3px solid #0d6efd;
        border-radius: 50%;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3);
    }

    .camera-controls {
        padding: 1rem;
    }

    .instructions {
        background: #e7f3ff;
        padding: 1rem;
        border-radius: 6px;
        border-left: 4px solid #0d6efd;
    }

    .instructions ul {
        margin: 0.5rem 0 0 0;
        padding-left: 1.5rem;
    }

    .preview-image {
        max-width: 100%;
        max-height: 400px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .preview-controls {
        margin-top: 1rem;
    }
</style>
